<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CapCut Web Editor ‚Äî Full</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* =========================
   GLOBAL / THEME
   ========================= */
:root{
  --bg:#0b0b0f;
  --panel:#0f1724;
  --muted:#9aa4b2;
  --accent:#7c3aed;
  --glass: rgba(255,255,255,0.04);
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html,body{height:100%; margin:0; font-family:Poppins,system-ui,Arial; background:var(--bg); color:#fff;}
button{font-family:inherit; cursor:pointer}

/* APP FRAME */
.app{max-width:1100px; margin:0 auto; height:100vh; display:flex; flex-direction:column; gap:8px; padding:8px;}
.topbar{height:56px; background:linear-gradient(90deg,#07101a,#0b0b0f); display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-radius:12px;}
.top-left{display:flex; align-items:center; gap:10px;}
.logo-badge{width:44px;height:44;border-radius:10px; display:flex;align-items:center;justify-content:center; font-weight:700; background:linear-gradient(90deg,#4f46e5,#7c3aed);}
.top-actions{display:flex; align-items:center; gap:8px;}

/* MAIN LAYOUT */
.main{flex:1; display:flex; gap:12px; min-height:0} /* min-height 0 so children can scroll */
.left-panel{width:260px; background:var(--panel); padding:12px; border-radius:12px; overflow:auto}
.center{flex:1; display:flex; flex-direction:column; gap:10px; min-height:0}
.right-panel{width:300px; background:var(--panel); padding:12px; border-radius:12px; overflow:auto}

/* PREVIEW */
.preview-card{background:#000;border-radius:12px; padding:8px; display:flex; flex-direction:column; gap:8px; min-height:300px; justify-content:center; align-items:center}
.preview-viewport{width:100%; background:#000; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative}
canvas#previewCanvas{display:block; width:100%; height:auto; max-height:60vh; background:#000;}

/* preview overlays */
.preview-top{position:absolute; top:8px; left:8px; right:8px; display:flex; justify-content:space-between; pointer-events:none}
.preview-controls{position:absolute; bottom:12px; left:12px; display:flex; gap:8px; pointer-events:auto}

/* TIMELINE */
.timeline-card{background:#071021; border-radius:12px; padding:8px; display:flex; flex-direction:column; gap:8px}
.timeline-scroll{overflow-x:auto; padding:8px; background:#06111a; border-radius:8px; white-space:nowrap; display:flex; gap:8px; align-items:center; min-height:96px}
.timeline-thumb{width:120px; height:72px; border-radius:8px; background:#0b1220; overflow:hidden; display:inline-flex; align-items:center; justify-content:center; position:relative; flex-shrink:0; border:1px solid rgba(255,255,255,0.03)}
.timeline-thumb img, .timeline-thumb video{width:100%; height:100%; object-fit:cover; display:block}
.thumb-duration{position:absolute; right:6px; bottom:6px; background:rgba(0,0,0,0.45); padding:4px 6px; border-radius:6px; font-size:12px}

/* TOOLBAR BOTTOM (mobile-style) */
.bottom-tools{display:flex; gap:6px; background:linear-gradient(180deg,#071021,#05101a); padding:8px; border-radius:12px; justify-content:space-around; align-items:center}
.tool-btn{display:flex; flex-direction:column; align-items:center; gap:6px; color:#e6eef8; background:transparent; border:0; font-size:12px}
.tool-btn svg{width:22px; height:22px}

/* LIST / LIBRARY */
.media-item{display:flex; gap:8px; align-items:center; padding:6px; background:#0b1220; border-radius:8px; cursor:grab}
.media-thumb{width:64px; height:48px; border-radius:6px; overflow:hidden; background:#222; display:flex; align-items:center; justify-content:center}
.media-meta{flex:1}

/* PROPERTIES */
.prop{background:var(--glass); padding:8px; border-radius:8px; margin-bottom:8px}
.prop label{font-size:13px; font-weight:600; display:block; margin-bottom:6px}

/* small helpers */
.small{font-size:12px; color:var(--muted)}
.pill{background:rgba(255,255,255,0.03); padding:6px 12px; border-radius:999px}

/* EXPORT overlay */
.export-overlay{position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); padding:12px 16px; border-radius:8px; z-index:999; display:none}

/* RESPONSIVE: collapse side panels under 900px */
@media (max-width: 900px){
  .left-panel, .right-panel{display:none}
  .main{flex-direction:column}
  .preview-card{min-height:55vh}
  canvas#previewCanvas{max-height:55vh}
  .timeline-scroll{min-height:120px}
}
</style>
</head>
<body>
<div class="app">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="top-left">
      <div class="logo-badge">CP</div>
      <div>
        <div style="font-weight:700">CapCut Web</div>
        <div class="small">Prototype ‚Äî HTML/JS</div>
      </div>
    </div>
    <div class="top-actions">
      <button id="newProjectBtn">Nouveau</button>
      <button id="saveBtn">Sauvegarder</button>
      <button id="loadBtn">Charger</button>
      <button id="exportBtn" style="background:linear-gradient(90deg,#4f46e5,#7c3aed);">Exporter</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- LEFT PANEL -->
    <aside class="left-panel" id="leftPanel">
      <h3>Biblioth√®que</h3>
      <div style="display:flex; gap:8px; margin-bottom:8px">
        <input id="mediaInput" type="file" accept="image/*,video/*" multiple style="display:none" />
        <button onclick="document.getElementById('mediaInput').click()">Uploader</button>
        <input id="audioInput" type="file" accept="audio/*" style="display:none" />
        <button onclick="document.getElementById('audioInput').click()">Audio</button>
      </div>

      <div id="mediaList" style="display:flex; flex-direction:column; gap:8px"></div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03); margin:10px 0">

      <div>
        <div class="small">Templates</div>
        <div style="display:flex; gap:8px; margin-top:8px">
          <button class="pill" data-tpl="birthday">Anniv</button>
          <button class="pill" data-tpl="travel">Voyage</button>
          <button class="pill" data-tpl="love">Love</button>
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <section class="center">
      <div class="preview-card">
        <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
          <div class="small" id="previewLabel">Pr√©visualisation</div>
          <div class="small" id="timeLabel">0.00s / 10s</div>
        </div>

        <div class="preview-viewport" id="previewViewport">
          <canvas id="previewCanvas" width="1280" height="720"></canvas>

          <div class="preview-top">
            <div class="small" id="resolutionLabel">1280√ó720</div>
            <div class="small" id="playStateLabel">Stopped</div>
          </div>

          <div class="preview-controls">
            <button id="playPauseBtn">Play</button>
            <button id="back1s">-1s</button>
            <button id="fwd1s">+1s</button>
            <label class="small" style="margin-left:8px">Zoom TL</label>
            <input id="timelineZoom" type="range" min="0.5" max="2" step="0.1" value="1" />
          </div>
        </div>

        <div class="timeline-card">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div class="small">Timeline</div>
            <div class="small">Drag & drop depuis la biblioth√®que</div>
          </div>

          <div class="timeline-scroll" id="timelineScroll" ondragover="event.preventDefault()">
            <!-- thumbnails go here -->
          </div>
        </div>
      </div>

      <!-- mobile bottom toolbox -->
      <div class="bottom-tools" id="bottomTools">
        <button class="tool-btn" data-tool="edit"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit</button>
        <button class="tool-btn" data-tool="audio"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 3v10.55A4 4 0 1 0 14 17V7h4V3h-6z"/></svg>Audio</button>
        <button class="tool-btn" data-tool="text"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M5 4v3h5.5v12h3V7H22V4z"/></svg>Text</button>
        <button class="tool-btn" data-tool="stickers"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2.04c-4.42 0-8 3.57-8 8a7.95 7.95 0 0 0 1.7 4.85L12 22l6.3-6.11A7.95 7.95 0 0 0 20 10.04c0-4.43-3.58-8-8-8z"/></svg>Stkr</button>
        <button class="tool-btn" data-tool="effects"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2l2.39 4.85L19 9l-4.29 2.16L12 16l-2.71-4.84L5 9l4.61-2.15z"/></svg>FX</button>
      </div>
    </section>

    <!-- RIGHT PANEL -->
    <aside class="right-panel" id="rightPanel">
      <h3>Propri√©t√©s</h3>
      <div id="propsArea">
        <div class="prop">
          <label>√âl√©ment s√©lectionn√©</label>
          <div class="small">Aucun</div>
        </div>
      </div>

      <div class="prop">
        <label>Audio</label>
        <div style="display:flex; gap:8px; align-items:center">
          <div class="small" id="audioName">Aucun</div><input id="audioVol" type="range" min="0" max="1" step="0.01" value="1" />
        </div>
      </div>
    </aside>
  </div>

  <!-- EXPORT OVERLAY -->
  <div id="exportOverlay" class="export-overlay">Export en cours‚Ä¶</div>

</div>
<!-- PARTIE 2: JS - base (media handling, timeline, preview) -->
<script>
/* =========================
   CapCut Web Editor - core
   ========================= */

/* ---------- STATE ---------- */
const state = {
  media: [],      // {id,file,type,url,duration,element}
  timeline: [],   // {id,refId,type,start,duration,filter,transition,text,z}
  selectedId: null,
  playhead: 0,
  playing: false,
  fps: 30,
  resolution: {w:1280,h:720},
  audio: null,
  undoStack: [],
  redoStack: [],
  projectName: 'Mon projet',
  duration: 10
};

/* ---------- DOM Refs ---------- */
const mediaInput = document.getElementById('mediaInput');
const mediaList = document.getElementById('mediaList');
const timelineScroll = document.getElementById('timelineScroll');
const previewCanvas = document.getElementById('previewCanvas');
const ctx = previewCanvas.getContext('2d');
const playPauseBtn = document.getElementById('playPauseBtn');
const back1s = document.getElementById('back1s');
const fwd1s = document.getElementById('fwd1s');
const timelineZoom = document.getElementById('timelineZoom');
const timeLabel = document.getElementById('timeLabel');
const resolutionLabel = document.getElementById('resolutionLabel');
const playStateLabel = document.getElementById('playStateLabel');
const propsArea = document.getElementById('propsArea');
const audioInput = document.getElementById('audioInput');
const audioNameEl = document.getElementById('audioName');
const audioVol = document.getElementById('audioVol');
const exportOverlay = document.getElementById('exportOverlay');
const exportBtn = document.getElementById('exportBtn');
const newProjectBtn = document.getElementById('newProjectBtn');
const saveBtn = document.getElementById('saveBtn');
const loadBtn = document.getElementById('loadBtn');

/* ---------- Utility ---------- */
const $ = s => document.querySelector(s);
const nowId = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function snapshot(){
  // push small snapshot to undo stack
  const snap = {
    media: state.media.map(m=>({id:m.id,url:m.url,type:m.type,duration:m.duration, name: m.file?.name || ''})),
    timeline: JSON.parse(JSON.stringify(state.timeline)),
    audio: state.audio ? {url: state.audio.url, name: state.audio.file?.name || ''} : null
  };
  state.undoStack.push(snap);
  if(state.undoStack.length>50) state.undoStack.shift();
  state.redoStack = [];
}
function undo(){
  if(!state.undoStack.length) return;
  const last = state.undoStack.pop();
  state.redoStack.push({
    media: state.media.map(m=>({id:m.id,url:m.url,type:m.type,duration:m.duration})),
    timeline: JSON.parse(JSON.stringify(state.timeline)),
    audio: state.audio ? {url: state.audio.url} : null
  });
  state.media = (last.media||[]).map(m=>({...m, element: new Image()}));
  state.timeline = last.timeline || [];
  if(last.audio) state.audio = {url:last.audio.url, element: new Audio(last.audio.url), file: null};
  renderAll();
}
function redo(){
  if(!state.redoStack.length) return;
  const last = state.redoStack.pop();
  state.undoStack.push({
    media: state.media.map(m=>({id:m.id,url:m.url,type:m.type,duration:m.duration})),
    timeline: JSON.parse(JSON.stringify(state.timeline)),
    audio: state.audio ? {url: state.audio.url} : null
  });
  state.media = (last.media||[]).map(m=>({...m, element: new Image()}));
  state.timeline = last.timeline || [];
  if(last.audio) state.audio = {url:last.audio.url, element: new Audio(last.audio.url), file: null};
  renderAll();
}

/* ---------- Media upload handling ---------- */
mediaInput.addEventListener('change', async (ev)=>{
  const files = Array.from(ev.target.files || []);
  if(!files.length) return;
  snapshot();
  for(const f of files){
    const url = URL.createObjectURL(f);
    const type = f.type.startsWith('video') ? 'video':'image';
    const id = nowId('m');
    let duration = 5;
    let element;
    if(type==='video'){
      element = document.createElement('video'); element.src = url; element.preload='metadata'; element.muted=true;
      await new Promise(r => element.addEventListener('loadedmetadata', r, {once:true}));
      duration = Math.max(1, Math.min(60, Math.round(element.duration) || 5));
    } else {
      element = new Image(); await new Promise(r => { element.onload = r; element.src = url; });
      duration = 5;
    }
    state.media.push({id, file:f, type, url, duration, element});
  }
  ev.target.value = '';
  renderAll();
});

/* audio upload */
audioInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  snapshot();
  const url = URL.createObjectURL(f);
  const audio = new Audio(url); audio.crossOrigin='anonymous';
  await new Promise(r => audio.addEventListener('loadedmetadata', r, {once:true}));
  state.audio = {file:f, url, element: audio};
  audioNameEl.textContent = f.name;
  ev.target.value = '';
  renderAll();
});

/* ---------- Timeline actions ---------- */
function addToTimeline(mediaId, atStart=null){
  snapshot();
  const media = state.media.find(m => m.id===mediaId);
  if(!media) return;
  const start = atStart!==null ? atStart : Math.max(0, state.timeline.reduce((mx,it)=>Math.max(mx, it.start + it.duration), 0));
  const item = { id: nowId('t'), refId: mediaId, type: 'media', start, duration: media.type==='video'?media.duration:5, filter:'none', transition:'none', text:null, z: state.timeline.length};
  state.timeline.push(item);
  renderAll();
}

/* drag from library onto timeline (drop) */
timelineScroll.addEventListener('drop', (ev)=>{
  ev.preventDefault();
  const mediaId = ev.dataTransfer.getData('text/media');
  if(!mediaId) return;
  const rect = timelineScroll.getBoundingClientRect();
  const x = ev.clientX - rect.left + timelineScroll.scrollLeft;
  const startTime = (x / (100 * parseFloat(timelineZoom.value))) ; // 100px per second base
  addToTimeline(mediaId, Math.max(0, Math.round(startTime*100)/100));
});

/* ---------- Render library & timeline ---------- */
function renderLibrary(){
  mediaList.innerHTML = '';
  for(const m of state.media){
    const el = document.createElement('div'); el.className='media-item';
    el.innerHTML = `<div class="media-thumb">${m.type==='video'? '<video muted playsinline preload="metadata" src="'+m.url+'"></video>' : '<img src="'+m.url+'" />'}</div>
                    <div class="media-meta"><div style="font-size:13px">${m.file?.name || m.url.split('/').pop()}</div><div class="small">${m.duration}s</div></div>
                    <div><button data-add="${m.id}">+</button></div>`;
    mediaList.appendChild(el);
    el.querySelector('[data-add]').addEventListener('click', ()=> addToTimeline(m.id));
    // dragstart
    el.addEventListener('dragstart', (e)=> e.dataTransfer.setData('text/media', m.id));
    el.draggable = true;
  }
}

function renderTimeline(){
  recalcDuration();
  timelineScroll.innerHTML = '';
  const zoom = parseFloat(timelineZoom.value);
  const width = Math.max(800, state.duration * 100 * zoom);
  timelineScroll.style.minWidth = width + 'px';

  // grid lines
  const gridCount = Math.ceil(state.duration);
  for(let i=0;i<=gridCount;i++){
    const line = document.createElement('div');
    line.style.position='absolute';
    line.style.left = (i*100*zoom) + 'px';
    // not adding lines to avoid overcomplicating DOM; we'll render playhead in canvas
  }

  // items
  state.timeline.forEach(it=>{
    if(it.type === 'media'){
      const m = state.media.find(x=>x.id===it.refId);
      const thumb = document.createElement('div'); thumb.className='timeline-thumb';
      thumb.dataset.id = it.id;
      thumb.style.left = (it.start*100*zoom) + 'px';
      thumb.style.width = (it.duration*100*zoom) + 'px';
      // inner content
      if(m){
        if(m.type==='video') thumb.innerHTML = `<video src="${m.url}" muted preload="metadata" style="width:100%;height:100%;object-fit:cover"></video>`;
        else thumb.innerHTML = `<img src="${m.url}" style="width:100%;height:100%;object-fit:cover" />`;
        const dur = document.createElement('div'); dur.className='thumb-duration'; dur.textContent = it.duration + 's'; thumb.appendChild(dur);
      } else {
        thumb.textContent = 'missing';
      }
      // click select
      thumb.addEventListener('click', (e)=>{ state.selectedId = it.id; renderProps(); });
      // drag for repositioning
      thumb.draggable = true;
      thumb.addEventListener('dragstart', (e)=> { e.dataTransfer.setData('text/titem', it.id) });
      timelineScroll.appendChild(thumb);
    } else if(it.type==='text' || it.type==='sticker'){
      // not implementing thumbnails for text/sticker here to keep simple layout; could add icons
    }
  });

  // support drops that move timeline items: drop on timelineScroll
  timelineScroll.addEventListener('drop', (ev)=>{
    ev.preventDefault();
    const titem = ev.dataTransfer.getData('text/titem');
    if(!titem) return;
    const rect = timelineScroll.getBoundingClientRect();
    const x = ev.clientX - rect.left + timelineScroll.scrollLeft;
    const newStart = Math.max(0, Math.round((x / (100*zoom))*100)/100);
    const it = state.timeline.find(i => i.id === titem);
    if(it){
      snapshot();
      it.start = newStart;
      renderAll();
    }
  });
}

/* ---------- Preview / draw ---------- */
function recalcDuration(){
  const mx = Math.max(0, ...state.timeline.map(it=> it.start + (it.duration||0)));
  state.duration = Math.max(6, Math.ceil(mx));
  document.getElementById('timeLabel').textContent = state.playhead.toFixed(2) + 's / ' + state.duration + 's';
}

function clearCanvas(){
  ctx.fillStyle = '#000'; ctx.fillRect(0,0, previewCanvas.width, previewCanvas.height);
}

function applyFilterCSS(name, adjustments={}){
  // returns CSS filter string for canvas context (ctx.filter)
  let s = '';
  if(name === 'bw') s += 'grayscale(100%) ';
  if(name === 'sepia') s += 'sepia(60%) ';
  if(name === 'vivid') s += 'saturate(1.3) contrast(1.05) ';
  if(adjustments.brightness) s += `brightness(${1+adjustments.brightness}) `;
  if(adjustments.contrast) s += `contrast(${1+adjustments.contrast}) `;
  if(adjustments.saturation) s += `saturate(${1+adjustments.saturation}) `;
  return s.trim() || 'none';
}

function drawFrame(t){
  clearCanvas();
  // find items active at t, sorted by z
  const items = state.timeline.filter(it => t >= it.start && t <= it.start + it.duration).sort((a,b)=> (a.z||0) - (b.z||0));
  items.forEach(it=>{
    if(it.type === 'media'){
      const m = state.media.find(mm=> mm.id === it.refId);
      if(!m) return;
      const el = m.element;
      const elw = el.videoWidth || el.naturalWidth || previewCanvas.width;
      const elh = el.videoHeight || el.naturalHeight || previewCanvas.height;
      const ratio = Math.min(previewCanvas.width / elw, previewCanvas.height / elh);
      const w = elw * ratio, h = elh * ratio;
      const x = (previewCanvas.width - w)/2, y = (previewCanvas.height - h)/2;
      ctx.save();
      ctx.filter = applyFilterCSS(it.filter || m.defaultFilter || 'none', it.adjustments || {});
      try{
        if(m.type === 'video'){ if(el.readyState >= 2) ctx.drawImage(el, x, y, w, h); }
        else { if(el.complete) ctx.drawImage(el, x, y, w, h); }
      }catch(e){}
      // text overlay
      if(it.text && it.text.content){
        ctx.filter = 'none';
        ctx.shadowColor = 'rgba(0,0,0,0.5)';
        ctx.shadowBlur = 8;
        ctx.fillStyle = it.text.color || 'white';
        ctx.font = `${it.text.size || 48}px ${it.text.font || 'Poppins'}`;
        ctx.fillText(it.text.content, it.text.x || 60, it.text.y || 80);
      }
      ctx.restore();
    } else if(it.type === 'text'){
      ctx.save();
      ctx.fillStyle = it.text.color || 'white';
      ctx.font = `${it.text.size||48}px ${it.text.font||'Poppins'}`;
      ctx.fillText(it.text.content, it.text.x||60, it.text.y||80);
      ctx.restore();
    }
  });

  // draw playhead bottom bar marker
  ctx.fillStyle = 'rgba(255,255,255,0.03)';
  ctx.fillRect(0, previewCanvas.height - 60, previewCanvas.width, 60);
  const px = (state.playhead / state.duration) * previewCanvas.width;
  ctx.fillStyle = '#ef4444';
  ctx.fillRect(px, previewCanvas.height - 60, 2, 60);
}

/* ---------- Playback loop ---------- */
let raf=null, startPerf=0;
function play(){
  if(state.playing) return;
  state.playing = true;
  startPerf = performance.now() - state.playhead*1000;
  // start video elements for preview (muted)
  state.media.forEach(m => { if(m.type==='video' && m.element){ try{ m.element.currentTime = state.playhead; m.element.muted = true; m.element.play(); }catch(e){} }});
  if(state.audio && state.audio.element){ try{ state.audio.element.currentTime = state.playhead; state.audio.element.play(); }catch(e){} }
  playPauseBtn.textContent = 'Pause';
  playStateLabel.textContent = 'Playing';
  raf = requestAnimationFrame(tick);
}
function pause(){
  if(!state.playing) return;
  state.playing = false;
  if(raf) cancelAnimationFrame(raf);
  state.media.forEach(m => { if(m.type==='video' && m.element){ try{ m.element.pause(); }catch(e){} }});
  if(state.audio && state.audio.element) state.audio.element.pause();
  playPauseBtn.textContent = 'Play';
  playStateLabel.textContent = 'Stopped';
}
function tick(ts){
  const t = (ts - startPerf)/1000;
  state.playhead = t;
  if(t >= state.duration){ state.playhead = state.duration; pause(); renderAll(); return; }
  drawFrame(state.playhead);
  timeLabel.textContent = state.playhead.toFixed(2) + 's / ' + state.duration + 's';
  raf = requestAnimationFrame(tick);
}

/* ---------- Controls binding ---------- */
playPauseBtn.addEventListener('click', ()=> state.playing ? pause() : play());
back1s.addEventListener('click', ()=> { state.playhead = Math.max(0, state.playhead - 1); drawFrame(state.playhead); timeLabel.textContent = state.playhead.toFixed(2) + 's / ' + state.duration + 's'; });
fwd1s.addEventListener('click', ()=> { state.playhead = Math.min(state.duration, state.playhead + 1); drawFrame(state.playhead); timeLabel.textContent = state.playhead.toFixed(2) + 's / ' + state.duration + 's'; });
timelineZoom.addEventListener('input', ()=> renderTimeline());

/* ---------- Props panel ---------- */
function renderProps(){
  const area = propsArea;
  area.innerHTML = '';
  const sel = state.timeline.find(it=> it.id === state.selectedId);
  if(!sel){ area.innerHTML = `<div class="prop"><label>√âl√©ment s√©lectionn√©</label><div class="small">Aucun</div></div>`; return; }
  const media = state.media.find(m=> m.id === sel.refId);
  const html = document.createElement('div');
  html.className = 'prop';
  html.innerHTML = `<label>Source: ${media?.file?.name || sel.refId}</label>
    <div>Dur√©e: <input id="propDur" type="range" min="1" max="60" value="${sel.duration}"> <span class="small" id="durLabel">${sel.duration}s</span></div>
    <div style="margin-top:8px">Transition:
      <select id="propTrans"><option value="none">None</option><option value="fade">Fondu</option><option value="slide">Glissement</option><option value="zoom">Zoom</option></select>
    </div>
    <div style="margin-top:8px">Filtre:
      <select id="propFilter"><option value="none">Aucun</option><option value="bw">N&B</option><option value="sepia">S√©pia</option><option value="vivid">Vif</option></select>
    </div>
    <div style="margin-top:8px">Texte: <input id="propText" type="text" value="${sel.text?.content || ''}" placeholder="Ajouter texte"></div>`;
  area.appendChild(html);
  document.getElementById('propDur').addEventListener('input', (e)=>{ snapshot(); sel.duration = parseInt(e.target.value); document.getElementById('durLabel').textContent = sel.duration + 's'; renderAll(); });
  document.getElementById('propTrans').value = sel.transition || 'none'; document.getElementById('propTrans').addEventListener('change',(e)=>{ snapshot(); sel.transition = e.target.value; renderAll(); });
  document.getElementById('propFilter').value = sel.filter || 'none'; document.getElementById('propFilter').addEventListener('change',(e)=>{ snapshot(); sel.filter = e.target.value; renderAll(); });
  document.getElementById('propText').addEventListener('change',(e)=>{ snapshot(); sel.text = sel.text || {}; sel.text.content = e.target.value; renderAll(); });
}

/* ---------- Misc: templates, new, save/load ---------- */
document.querySelectorAll('[data-tpl]').forEach(b => b.addEventListener('click', ()=>{
  const tpl = b.dataset.tpl;
  snapshot();
  if(tpl === 'birthday' && state.media.length >= 3){
    state.timeline = [
      {id:nowId('t'), refId: state.media[0].id, type:'media', start:0, duration:3, filter:'vivid', transition:'fade', text:{content:'Joyeux', x:60,y:80,size:56}, z:0},
      {id:nowId('t'), refId: state.media[1].id, type:'media', start:3, duration:3, filter:'sepia', transition:'slide', text:{content:'Anniversaire', x:60,y:500,size:48}, z:1},
      {id:nowId('t'), refId: state.media[2].id, type:'media', start:6, duration:4, filter:'vivid', transition:'zoom', text:{content:'üéâ', x:1000,y:200,size:72}, z:2}
    ];
  } else if(tpl === 'travel' && state.media.length >= 2){
    state.timeline = [
      {id:nowId('t'), refId: state.media[0].id, type:'media', start:0, duration:4, filter:'vivid', transition:'slide', text:{content:'Voyage', x:60,y:120,size:56}, z:0},
      {id:nowId('t'), refId: state.media[1].id, type:'media', start:4, duration:5, filter:'bw', transition:'fade', text:{content:'Aventure', x:60,y:600,size:48}, z:1}
    ];
  } else if(tpl === 'love' && state.media.length >= 2){
    state.timeline = [
      {id:nowId('t'), refId: state.media[0].id, type:'media', start:0, duration:4, filter:'sepia', transition:'fade', text:{content:'Notre Histoire', x:60,y:120,size:56}, z:0},
      {id:nowId('t'), refId: state.media[1].id, type:'media', start:4, duration:4, filter:'vivid', transition:'zoom', text:{content:'üíñ', x:1000,y:300,size:80}, z:1}
    ];
  } else alert('Ajoute plus de m√©dias pour ce template.');
  renderAll();
}));

newProjectBtn.addEventListener('click', ()=>{
  if(!confirm('Nouveau projet ? Tout sera perdu.')) return;
  snapshot();
  state.media = []; state.timeline = []; state.audio = null; state.playhead = 0; renderAll();
});

saveBtn.addEventListener('click', ()=>{
  const payload = { media: state.media.map(m=>({id:m.id,url:m.url,type:m.type,duration:m.duration,name:m.file?.name})), timeline: state.timeline, audio: state.audio?{url:state.audio.url}:null };
  const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'project.json'; a.click();
});

loadBtn.addEventListener('click', async ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const text = await f.text();
    const obj = JSON.parse(text);
    snapshot();
    state.media = (obj.media||[]).map(m => ({...m, element: new Image(), file:null}));
    state.timeline = obj.timeline || [];
    if(obj.audio) state.audio = {url: obj.audio.url, element: new Audio(obj.audio.url), file: null};
    renderAll();
  });
  input.click();
});
<!-- PARTIE 3: JS - editing features, export, final render -->
<script>
/* ---------- continue from PARTIE 2 ---------- */

/* render library + timeline + canvas */
function renderAll(){
  renderLibrary();
  renderTimeline();
  renderProps();
  // canvas resolution
  previewCanvas.width = state.resolution.w;
  previewCanvas.height = state.resolution.h;
  // ensure elements have src set
  state.media.forEach(m=>{
    if(!m.element) { m.element = m.type==='video'? document.createElement('video') : new Image(); m.element.src = m.url; }
  });
  drawFrame(state.playhead);
  document.getElementById('timeLabel').textContent = state.playhead.toFixed(2) + 's / ' + state.duration + 's';
  resolutionLabel.textContent = previewCanvas.width + '√ó' + previewCanvas.height;
}

/* ---------- Editing utilities ---------- */
function findActiveItemAtPlayhead(){
  return state.timeline.find(it => state.playhead >= it.start && state.playhead <= it.start + it.duration);
}

function splitAtPlayhead(){
  const it = findActiveItemAtPlayhead();
  if(!it) return alert('Aucun √©l√©ment √† split');
  snapshot();
  const t = state.playhead;
  if(t <= it.start || t >= it.start + it.duration) return alert('Split hors √©l√©ment');
  const left = {...it, id: nowId('t'), duration: Math.round((t - it.start)*100)/100};
  const right = {...it, id: nowId('t'), start: Math.round(t*100)/100, duration: Math.round((it.start + it.duration - t)*100)/100};
  state.timeline = state.timeline.filter(i=> i.id !== it.id);
  state.timeline.push(left, right);
  renderAll();
}

function trimSelected(){
  const it = state.timeline.find(i=> i.id === state.selectedId) || findActiveItemAtPlayhead();
  if(!it) return alert('S√©lectionne un √©l√©ment pour trim');
  const newDur = prompt('Nouvelle dur√©e (s)', String(it.duration));
  const d = parseFloat(newDur);
  if(isNaN(d) || d <= 0) return alert('Dur√©e invalide');
  snapshot();
  it.duration = d;
  renderAll();
}

/* add text overlay as timeline item */
function addTextOverlay(text){
  snapshot();
  const item = { id: nowId('t'), refId: null, type: 'text', start: state.playhead, duration: 3, text: { content:text, x:60, y:80, size:48, font:'Poppins', color:'white'}, z: state.timeline.length };
  state.timeline.push(item);
  renderAll();
}

/* add sticker overlay */
function addSticker(icon){
  snapshot();
  const item = { id: nowId('t'), refId: null, type: 'sticker', start: state.playhead, duration: 3, sticker: { icon, x: state.resolution.w/2-40, y: state.resolution.h/2-40, size:72 }, z: state.timeline.length };
  state.timeline.push(item);
  renderAll();
}

/* apply filter to current item */
function applyFilterToCurrent(name){
  const it = state.timeline.find(i => i.id === state.selectedId) || findActiveItemAtPlayhead();
  if(!it) return alert('S√©lectionne un √©l√©ment');
  snapshot();
  it.filter = name;
  renderAll();
}

/* ---------- Hook up bottom toolbar tools ---------- */
document.getElementById('bottomTools').addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-tool]');
  if(!btn) return;
  const tool = btn.dataset.tool;
  if(tool === 'edit') {
    // open small edit menu (split/trim)
    if(confirm('Split ici ?')) splitAtPlayhead();
  } else if(tool === 'audio'){
    document.getElementById('audioInput').click();
  } else if(tool === 'text'){
    const txt = prompt('Texte √† ajouter');
    if(txt) addTextOverlay(txt);
  } else if(tool === 'stickers'){
    const s = prompt('Sticker emoji (ex: üéâ, ‚ù§Ô∏è, ‚≠ê)');
    if(s) addSticker(s);
  } else if(tool === 'effects'){
    const f = prompt('Filtre: none, bw, sepia, vivid', 'vivid');
    if(f) applyFilterToCurrent(f);
  }
});

/* keyboard shortcuts */
window.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){ e.preventDefault(); state.playing ? pause() : play(); }
  if((e.ctrlKey || e.metaKey) && e.key === 'z'){ undo(); renderAll(); }
  if((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))){ redo(); renderAll(); }
  if(e.key === 'Delete' || e.key === 'Backspace'){ if(state.selectedId){ snapshot(); state.timeline = state.timeline.filter(i=> i.id !== state.selectedId); state.selectedId=null; renderAll(); } }
});

/* ---------- export: MediaRecorder (canvas + audio) ---------- */
async function startExport(format='1080p'){
  const formats = {'720p':{w:1280,h:720}, '1080p':{w:1920,h:1080}, '9:16':{w:720,h:1280}, '1:1':{w:1080,h:1080}};
  const r = formats[format] || formats['1080p'];
  snapshot();
  exportOverlay.style.display = 'block';
  // set canvas size
  previewCanvas.width = r.w; previewCanvas.height = r.h;
  // get canvas stream
  const canvasStream = previewCanvas.captureStream(state.fps);
  let mixedStream = canvasStream;
  if(state.audio && state.audio.element && state.audio.element.captureStream){
    try{
      const audioStream = state.audio.element.captureStream();
      const ctxAudio = new (window.AudioContext || window.webkitAudioContext)();
      const dest = ctxAudio.createMediaStreamDestination();
      const src = ctxAudio.createMediaStreamSource(audioStream);
      src.connect(dest);
      mixedStream = new MediaStream([...canvasStream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
    }catch(e){
      console.warn('audio mix failed', e);
      mixedStream = canvasStream;
    }
  }
  const mime = 'video/webm;codecs=vp9';
  let mr;
  try{ mr = new MediaRecorder(mixedStream, {mimeType: mime}); } catch(e){ alert('Export non support√©'); exportOverlay.style.display='none'; return; }
  const chunks = [];
  mr.ondataavailable = (ev)=> { if(ev.data && ev.data.size) chunks.push(ev.data); };
  mr.onstop = ()=>{
    const blob = new Blob(chunks, {type:'video/webm'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `capcut_export_${Date.now()}.webm`; a.click();
    exportOverlay.style.display = 'none';
    // restore canvas to default resolution
    previewCanvas.width = state.resolution.w; previewCanvas.height = state.resolution.h;
    renderAll();
  };
  // start
  if(state.audio && state.audio.element){ state.audio.element.currentTime = 0; state.audio.element.play(); }
  state.media.forEach(m => { if(m.type==='video' && m.element){ try{ m.element.currentTime = 0; m.element.play(); }catch(e){} }});
  mr.start(1000);

  const start = performance.now();
  (function renderExport(now){
    const t = (now - start)/1000;
    drawFrame(t);
    if(t >= state.duration){
      mr.stop();
      if(state.audio && state.audio.element) state.audio.element.pause();
      state.media.forEach(m => { if(m.type==='video' && m.element) try{ m.element.pause(); }catch(e){} });
      return;
    }
    requestAnimationFrame(renderExport);
  })(performance.now());
}

/* export button handlers */
exportBtn.addEventListener('click', ()=>{
  const choice = prompt('Format export: 720p, 1080p, 9:16, 1:1', '1080p');
  startExport(choice);
});

/* ---------- initial render ---------- */
renderAll();

/* small demo helper: if no media, show hint */
if(state.media.length === 0){
  const hint = document.createElement('div'); hint.className='small'; hint.style.marginTop='12px'; hint.textContent = 'Tape / clique sur "Uploader" pour ajouter des images/vid√©os (glisser depuis la biblioth√®que vers la timeline).';
  document.getElementById('leftPanel').appendChild(hint);
}
</script>
</body>
</html>