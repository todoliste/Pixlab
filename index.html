<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PixLab Editor</title>
<style>
body {margin:0; font-family:Arial; background:#0f0f0f; color:white; overflow:hidden;}
#editor {position:relative; width:100vw; height:80vh; background:#111; display:flex; align-items:center; justify-content:center; overflow:hidden;}
#image {position:absolute; transform-origin:center center; max-width:100%; max-height:100%;}
#crop {position:absolute; border:2px solid white; box-sizing:border-box; touch-action:none;}
.handle {width:20px; height:20px; background:white; border-radius:50%; position:absolute; transform:translate(-50%,-50%);}
.handle.tl {top:0; left:0;} .handle.tr {top:0; right:0;} .handle.bl {bottom:0; left:0;} .handle.br {bottom:0; right:0;}
#tools {position:fixed; bottom:0; left:0; right:0; height:20vh; background:#111; display:flex; flex-wrap:wrap; padding:5px; gap:5px; align-items:center; justify-content:center;}
button,input[type=range]{background:#222; border:none; padding:6px 10px; color:white; border-radius:6px;}
input[type=range]{width:80px;}
#file{position:fixed;top:10px;left:10px; z-index:20;}
</style>
</head>
<body>
<input type="file" id="file" accept="image/*">
<div id="editor">
<img id="image">
<div id="crop"><div class="handle tl"></div><div class="handle tr"></div><div class="handle bl"></div><div class="handle br"></div></div>
</div>
<div id="tools">
<button id="exportBtn">Exporter PNG</button>
<input type="range" id="radius" min="0" max="150" value="0" title="Border radius">
</div>
<script>
const img=document.getElementById("image");
const crop=document.getElementById("crop");
const radiusSlider=document.getElementById("radius");
let imgX=0,imgY=0,scale=1,dragging=false,startX=0,startY=0;

document.getElementById("file").onchange=e=>{
    const file=e.target.files[0];
    img.src=URL.createObjectURL(file);
    img.onload=()=>{
        // adapter l'image à l'écran
        const editor=document.getElementById("editor");
        const w=img.naturalWidth, h=img.naturalHeight;
        const ew=editor.clientWidth, eh=editor.clientHeight;
        let ratio=Math.min(ew/w, eh/h);
        img.style.width=(w*ratio)+'px';
        img.style.height=(h*ratio)+'px';
        imgX=(ew-w*ratio)/2;
        imgY=(eh-h*ratio)/2;
        img.style.left=imgX+'px'; img.style.top=imgY+'px';
        scale=1;
        // crop centré
        crop.style.left=(imgX+50)+'px';
        crop.style.top=(imgY+50)+'px';
        crop.style.width='200px'; crop.style.height='200px';
        crop.style.borderRadius='0px';
    }
};

// drag image
document.addEventListener("mousedown",e=>{if(e.target===img){dragging=true; startX=e.clientX-imgX; startY=e.clientY-imgY;}});
document.addEventListener("mousemove",e=>{if(dragging){imgX=e.clientX-startX; imgY=e.clientY-startY; img.style.left=imgX+'px'; img.style.top=imgY+'px';}});
document.addEventListener("mouseup",()=>dragging=false);

// border radius
radiusSlider.oninput=()=>crop.style.borderRadius=radiusSlider.value+'px';

// export
document.getElementById("exportBtn").onclick=()=>{
    const r=crop.getBoundingClientRect();
    const editor=document.getElementById("editor").getBoundingClientRect();
    const canvas=document.createElement("canvas");
    canvas.width=r.width; canvas.height=r.height;
    const ctx=canvas.getContext("2d");

    // clipping
    const radius=parseInt(radiusSlider.value);
    if(radius>0){
        ctx.beginPath();
        ctx.moveTo(radius,0); ctx.lineTo(canvas.width-radius,0);
        ctx.quadraticCurveTo(canvas.width,0,canvas.width,radius);
        ctx.lineTo(canvas.width,canvas.height-radius); ctx.quadraticCurveTo(canvas.width,canvas.height,canvas.width-radius,canvas.height);
        ctx.lineTo(radius,canvas.height); ctx.quadraticCurveTo(0,canvas.height,0,canvas.height-radius);
        ctx.lineTo(0,radius); ctx.quadraticCurveTo(0,0,radius,0);
        ctx.closePath(); ctx.clip();
    }

    const offsetX=r.left-editor.left;
    const offsetY=r.top-editor.top;
    ctx.drawImage(img,-offsetX,-offsetY,img.width,img.height);
    const link=document.createElement("a");
    link.href=canvas.toDataURL("image/png");
    link.download="pixlab.png"; link.click();
};
</script>
</body>
</html>